#!/bin/bash
#$ -N diamond
#$ -cwd
#$ -j y
#$ -pe smp 48
#$ -R y
#$ -l h_vmem=500G,virtual_free=400G
#$ -S /bin/bash
#$ -q main.q@@himem

infasta=$1 #'results/08_transdecoder/Trinity_with_ORF.fasta'
outdaa=$2 #'Trinity_with_ORF_nr-blastx.daa'
outdir=$3 #'results/09_diamond/'

hostname
date
echo "job $JOB_ID started"
echo " "

#Ensure /scratch is not full.
dir="/scratch"   
reqSpace=10     #in GByte
availSpace=$(df -BG "${dir}" | awk 'NR==2 { print $4+0 }')
if (( availSpace < reqSpace )); then
  echo "not enough Space" >&2
  exit 1
fi

mkdir /scratch/$JOB_ID
cd /scratch/$JOB_ID
cp $infasta .
echo "fasta seq file copied"
echo " "

echo " "
echo "diamond started"
date
echo " "
diamond blastx -p $NSLOTS -d YOURDB/blastdb/ncbi-diamond/nr.dmnd\
 -q $(basename $infasta) -f 100 -o $outdaa --more-sensitive -e 0.00001 --max-target-seqs 50

echo " "
echo "diamond completed"
date
echo " "

echo "moving results"
echo " "
rm $(basename $infasta)
gzip $outdaa
mkdir -p $outdir
mv * $outdir
rm -r /scratch/tmp.$JOB_ID/*

echo "job $JOB_ID finished."
date