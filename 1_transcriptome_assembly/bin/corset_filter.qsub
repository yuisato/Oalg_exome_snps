#!/bin/bash
#$ -N cor_fil
#$ -cwd
#$ -j y
#$ -pe smp 1
#$ -R y
#$ -S /bin/bash
#$ -q main.q@@intelhosts

#corset_filter.sh located in bin

cluster_file=$1	#results/t12_corset/corset_out-clusters.txt etc.
contig_file=$2 	#results/t11_blast/candidate_annelids-hit_Olavius_transcript.fasta etc.
prefix=$3       #candidate_Annelida_nr-megan_hits_Oalg_transcripts_verC3 etc.
outdir=$4       #results/11_corset/ etc.

echo "job ID: $JOB_ID"
hostname
echo "job started"
date
echo " "

#Ensure /scratch is not full.
dir="/scratch"   
reqSpace=10     #in GByte
availSpace=$(df -BG "${dir}" | awk 'NR==2 { print $4+0 }')
if (( availSpace < reqSpace )); then
  echo "not enough Space" >&2
  exit 1
fi

mkdir -p /scratch/tmp.$JOB_ID
cd /scratch/tmp.$JOB_ID
cp $cluster_file clusters.txt
cp $contig_file trans.fasta
echo "files copied"
echo " "

echo "indexing contig fasta"
echo " "
samtools faidx trans.fasta

echo "pick-longest per cluster"
echo " "
perl bin/pick_longest_contig_per_corset_cluster.pl > ${prefix}_contigs_to_keep.info
cat ${prefix}_contigs_to_keep.info | cut -f2 > contigs_to_keep.list
seqtk subseq trans.fasta contigs_to_keep.list > ${prefix}_corset.fasta
echo " "

echo "moving result"
mkdir -p $outdir
mv ${prefix}_contigs_to_keep.info $outdir
mv ${prefix}_corset.fasta $outdir
rm -r /scratch/tmp.$JOB_ID/*

echo "job ID: $JOB_ID finished."
date
