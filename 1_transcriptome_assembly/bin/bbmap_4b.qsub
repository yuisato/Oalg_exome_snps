#!/bin/bash
#$ -N bbmap
#$ -cwd
#$ -j y
#$ -pe smp 8
#$ -R y
#$ -S /bin/bash
#$ -q main.q@@intelhosts

infile=$1 #results/02_prep/*R1_prep.fa.gz
outdir=$2 #results/04_bbmap

echo "job ID: $JOB_ID"
hostname
echo "job started"
date
echo " "

#Ensure /scratch is not full.
dir="/scratch"   
reqSpace=10     #in GByte
availSpace=$(df -BG "${dir}" | awk 'NR==2 { print $4+0 }')
if (( availSpace < reqSpace )); then
  echo "not enough Space" >&2
  exit 1
fi

mkdir -p /scratch/tmp.$JOB_ID
cd /scratch/tmp.$JOB_ID
cp $infile read1.fa.gz
cp $(echo $infile | sed 's/R1_prep.fa.gz/R2_prep.fa.gz/') read2.fa.gz
echo "$infile and R2 copied"
cp data/ref/Drosophila_GCF_000001215.4_Release_6_plus_ISO1_MT_genomic.fna.gz drosophila.fa.gz
 # refrence genome downloaded from 
 # ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/001/215/GCF_000001215.4_Release_6_plus_ISO1_MT/GCF_000001215.4_Release_6_plus_ISO1_MT_genomic.fna.gz
cp data/ref/symbiont_genomes_2017_7.fasta symbionts.fasta
 # reference genomes assembled from O.algarvensis symbionts. Provided in data/ref
echo "ref copied"
date
echo " "

echo "########## bbmap stage1 (Drosophila) started"
date
echo " "
bbmap.sh in=read1.fa.gz in2=read2.fa.gz\
 ref=drosophila.fa.gz\
 outu=unmapped_dro1.fa outu2=unmapped_dro2.fa\
 minid=0.9 maxindel=50000 unpigz pigz overwrite=t t=$NSLOTS
rm read?.fa.gz
echo "bbmap stage1 (Drosophila) complete"
date
echo " "

echo "########## bbmap stage2 (Oalg_symb_2017) started"
date
echo " "
bbmap.sh in=unmapped_dro1.fa in2=unmapped_dro2.fa\
 ref=symbionts.fasta\
 outu=$(echo $(basename $infile) | sed 's/_R1_prep.fa.gz//')_R1_prep.fa.gz\
 outu2=$(echo $(basename $infile) | sed 's/_R1_prep.fa.gz//')_R2_prep.fa.gz\
 minratio=0.9 unpigz pigz overwrite=t t=$NSLOTS
rm unmapped_dro*.fa
echo "bbmap stage2 (Oalg_symb_2017) complete"
date
echo " "

rm drosophila.fa.gz symbionts.fasta

echo "########## moving result"
mkdir -p $outdir
mv * $outdir
rm -r /scratch/tmp.$JOB_ID/*

echo "job ID: $JOB_ID finished."
date

mv bbmap.o$JOB_ID\
   $outdir/$(echo $(basename $infile) | sed 's/_R1_prep.fa.gz//')_bbmap.log
