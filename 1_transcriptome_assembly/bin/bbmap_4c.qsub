#!/bin/bash
#$ -N bbmap
#$ -cwd
#$ -j y
#$ -pe smp 16
#$ -R y
#$ -S /bin/bash
#$ -q main.q@@intelhosts

infile=$1 #results/02_prep/*R1_prep.fa.gz
outdir=$2 #results/04_bbmap

echo "job ID: $JOB_ID"
hostname
echo "job started"
date
echo " "

#Ensure /scratch is not full.
dir="/scratch"   
reqSpace=10     #in GByte
availSpace=$(df -BG "${dir}" | awk 'NR==2 { print $4+0 }')
if (( availSpace < reqSpace )); then
  echo "not enough Space" >&2
  exit 1
fi

mkdir -p /scratch/tmp.$JOB_ID
cd /scratch/tmp.$JOB_ID
cp $infile read1.fa.gz
cp $(echo $infile | sed 's/R1_prep.fa.gz/R2_prep.fa.gz/') read2.fa.gz
echo "$infile and R2 copied"
cp data/ref/Human_GCF_000001405.36_GRCh38.p10_rna.fna.gz human.fa.gz
echo "human ref copied"
 # Human genome downloaed from;
 # ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/001/405/GCF_000001405.36_GRCh38.p10/GCF_000001405.36_GRCh38.p10_rna.fna.gz 
date
echo " "

echo "########## bbmap started:  mapping to human with 95% ID "
date
echo " "
bbmap.sh in=read1.fa.gz in2=read2.fa.gz\
 covstats=$outdir/human_contami_check/$(echo $(basename $infile) | sed 's/_R1_prep.fa.gz//')_human_contami_bbmap.covstats\
 ref=human.fa.gz minid=0.95 maxindel=100000 unpigz pigz overwrite=t nodisk t=$NSLOTS
echo "bbmap complete"
echo "covstats written in $outdir/human_contami_check/$(echo $(basename $infile) | sed 's/_R1_prep.fa.gz//')_human_contami_bbmap.covstats"
date
echo " "

rm -r /scratch/tmp.$JOB_ID/*
echo "job ID: $JOB_ID finished."
date
echo "log written in $outdir/human_contami_check/$(echo $(basename $infile) | sed 's/_R1_prep.fa.gz//')_human_contami_bbmap.log"

mkdir -p $outdir/human_contami_check
mv bbmap.o$JOB_ID\
    $outdir/human_contami_check/$(echo $(basename $infile) | sed 's/_R1_prep.fa.gz//')_human_contami_bbmap.log
