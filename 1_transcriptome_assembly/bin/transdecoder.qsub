#!/bin/bash
#$ -N transdec
#$ -cwd
#$ -j y
#$ -pe smp 24
#$ -R y
#$ -S /bin/bash
#$ -q main.q@@intelhosts

infile=$1	#'results/07_bbmap_cov_filter/candidate_isoforms.fasta'
trainfile=$2	#'results/09b_megan/Annelids_cds_hits_1000.fasta'
outdir=$3	#'results/08_transdecoder/'

hostname
echo "job $JOB_ID started"
date
echo " "

#Ensure /scratch is not full.
dir="/scratch"   
reqSpace=10     #in GByte
availSpace=$(df -BG "${dir}" | awk 'NR==2 { print $4+0 }')
if (( availSpace < reqSpace )); then
  echo "not enough Space" >&2
  exit 1
fi

mkdir -p /scratch/tmp.$JOB_ID
cd /scratch/tmp.$JOB_ID
cp $infile .
cp $trainfile .
echo "files copied"
echo " "
echo "transdecoder_longORF started"
echo " "
TransDecoder.LongOrfs -t $(basename $infile)

echo " "
echo "transdecoder_predict started"
echo " "
TransDecoder.Predict -t $(basename $infile) --cpu $NSLOTS --train $(basename $trainfile) --retain_long_orfs 300

echo " "
echo "moving result"
echo " "
mkdir -p $outdir
mv *transdecoder.* $outdir
rm -r /scratch/tmp.$JOB_ID/*

echo "job ID: $JOB_ID finished."
date