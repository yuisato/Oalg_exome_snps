#!/bin/bash
#$ -N corset
#$ -cwd
#$ -j y
#$ -pe smp 16
#$ -R y
#$ -S /bin/bash
#$ -q main.q@@intelhosts

#corset.qsub located in bin

bamfiles=$1 #results/11_corset/candidate_*_nr-megan_hits_Oalg_transcripts_ver*.bam etc.
grouping=$2 #1,1,2,2,2,1 etc.
outdir=$3 #results/11_corset/ etc.
prefix=$4 #candidate_Bilateria_nr-megan_hits_Oalg_transcripts_verC3 etc.
echo "job ID: $JOB_ID"
hostname
echo "job started"
date
echo " "

#Ensure /scratch is not full.
dir="/scratch"   
reqSpace=10     #in GByte
availSpace=$(df -BG "${dir}" | awk 'NR==2 { print $4+0 }')
if (( availSpace < reqSpace )); then
  echo "not enough Space" >&2
  exit 1
fi

mkdir -p /scratch/tmp.$JOB_ID
cd /scratch/tmp.$JOB_ID
cp $bamfiles .
echo "bam files copied"
echo " "

echo "corset started"
date
echo " "
for file in $(ls *.bam); do corset -r true-stop $file & done
wait
corset -i corset *.corset-reads -g $grouping -p ${prefix}_corset_out -f true
echo " "
date
echo " "

echo "moving result"
mkdir -p $outdir
mv ${prefix}_corset_out*txt $outdir
rm -r /scratch/tmp.$JOB_ID/*

echo "job ID: $JOB_ID finished."
date


