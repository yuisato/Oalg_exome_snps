#!/bin/bash
#$ -N busco
#$ -cwd
#$ -j y
#$ -pe smp 8
#$ -R y
#$ -S /bin/bash
#$ -q main.q@@intelhosts

infile=$1 #assembly file
outdir=$2 #results folder

hostname
date
echo "job $JOB_ID started"
echo " "

#Ensure /scratch is not full.
dir="/scratch"   
reqSpace=10     #in GByte
availSpace=$(df -BG "${dir}" | awk 'NR==2 { print $4+0 }')
if (( availSpace < reqSpace )); then
  echo "not enough Space" >&2
  exit 1
fi

mkdir /scratch/$JOB_ID
cd /scratch/$JOB_ID
cp $infile .
echo "files copied"
echo " "
echo "busco started"
BUSCO.py -i $(basename ${infile}) -o $(basename ${infile} | sed 's/.fasta//') -l YOURTOOLS/busco/metazoa_odb9 -m tran -c $NSLOTS -f

echo " "
echo "busco completed"
date
echo " "

echo "moving results"
echo " "
mkdir -p $outdir
mv run_"$(basename ${infile} | sed 's/.fasta//')"/full_table*tsv $outdir
mv run_"$(basename ${infile} | sed 's/.fasta//')"/*txt $outdir
rm -r /scratch/tmp.$JOB_ID/*
echo "job $JOB_ID finished."
date

mv busco.o$JOB_ID logs