#!/bin/bash
#$ -N seqprep
#$ -cwd
#$ -j y
#$ -pe smp 16
#$ -R y
#$ -S /bin/bash
#$ -q main.q@@intelhosts


infile=$1 #YOURDATA*R1.fq.gz (one of pair-end read files)
outdir=$2 #results/02_prep/ etc.

echo "job ID: $JOB_ID"
hostname
echo "job started"
date
echo " "

#Ensure /scratch is not full.
dir="/scratch"   
reqSpace=10     #in GByte
availSpace=$(df -BG "${dir}" | awk 'NR==2 { print $4+0 }')
if (( availSpace < reqSpace )); then
  echo "not enough Space" >&2
  exit 1
fi

mkdir -p /scratch/tmp.$JOB_ID
cd /scratch/tmp.$JOB_ID
cp $(echo $infile | sed 's/R1.fq.gz/R*.fq.gz/') .
echo "PE files copied"
date
echo " "

echo "########## bbduk started"
date
echo " "
bbduk2.sh in=$(basename ${infile}) in2=$(echo $(basename $infile) | sed 's/R1.fq.gz/R2.fq.gz/') \
 lref=YOURTOOLS/bbmap/resources/adapters.fa rref=YOURTOOLS/bbmap/resources/adapters.fa \
 fref=YOURTOOLS/bbmap/resources/phix174_ill.ref.fa.gz \
 out=tmp1_trim.fq out2=tmp2_trim.fq stats=$(echo $(basename $infile) | sed 's/_raw_R1.fq.gz//')_bbduk.stats\
 threads=$NSLOTS mink=10 edist=1 trimq=13 qtrim=rl minlength=65 overwrite=true
echo "bbduk complete"
date
echo " "

echo "########## seecer started"
date
echo " "
mkdir tmp
run_seecer.sh -t tmp tmp1_trim.fq tmp2_trim.fq  #results will be tmp1_trim.fq_corrected.fa and tmp2_trim.fq_corrected.fa
rm tmp*_trim.fq
rm -rf tmp
echo "seecer complete"
date
echo " "

echo "########## bbmap stage1 (rRNA) started"
date
echo " "
bbmap.sh in=tmp1_trim.fq_corrected.fa in2=tmp2_trim.fq_corrected.fa\
 ref=data/ref/rRNA_rfam_silva.fa.gz\
 outu=unmapped_rRNA.1.fa outu2=unmapped_rRNA.2.fa\
 k=15 minid=0.6 minhits=2 maxindel=3 strictmaxindel unpigz pigz overwrite=t t=$NSLOTS\
 statsfile=$(echo $(basename $infile) | sed 's/_raw_R1.fq.gz//')_bbmap_rRNA_mapping.stats
# reference rRNA is a concatenated fasta based on sortmeRNA database (provided as data/ref/rRNA_rfam_silva.fa.gz)
rm tmp*_trim.fq_corrected.fa
echo "bbmap stage1 (rRNA) complete"
date
echo " "

echo "########## bbmap stage2 (Oalg_symb_mt) started"
date
echo " "
bbmap.sh in=unmapped_rRNA.1.fa in2=unmapped_rRNA.2.fa\
 ref=data/ref/Oalg_symb_bins_and_mt.fa.gz\
 outu=$(echo $(basename $infile) | sed 's/_raw_R1.fq.gz//')_R1_prep.fa.gz\
 outu2=$(echo $(basename $infile) | sed 's/_raw_R1.fq.gz//')_R2_prep.fa.gz\
 fast k=15 minhits=2 minratio=0.9 unpigz pigz overwrite=t t=$NSLOTS\
 statsfile=$(echo $(basename $infile) | sed 's/_raw_R1.fq.gz//')_bbmap_symb_mt_mapping.stats
# reference file is a concatenated fasta of O.algarvensis symbiont genomes and O. algarvensis mitochondrial genomes.
#  provided as data/ref/Oalg_symb_bins_and_mt.fa.gz)
rm unmapped_rRNA.*.fa
echo "bbmap stage2 (Oalg_symb_mt) complete"
date
echo " "

echo "########## moving result"
mkdir -p $outdir
mv * $outdir
rm -r /scratch/tmp.$JOB_ID/*

echo "job ID: $JOB_ID finished."
date


